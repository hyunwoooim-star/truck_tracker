rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function: Check if user owns the truck
    function isTruckOwner(truckId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/trucks/$(truckId)).data.ownerId == request.auth.uid;
    }

    // Helper function: Check if user is admin
    function isAdmin() {
      return isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function: Check if user is owner of this truck
    function isOwnerOfThisTruck() {
      return isAuthenticated()
        && resource.data.ownerId == request.auth.uid;
    }

    // ═══════════════════════════════════════════════════════════
    // TRUCKS
    // ═══════════════════════════════════════════════════════════
    match /trucks/{truckId} {
      allow read: if true;  // Public read for customers

      // Create: Admins only (truck registration via admin approval)
      allow create: if isAdmin();

      // Update: Truck owner or admin
      allow update: if isOwnerOfThisTruck() || isAdmin();

      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // Truck menus subcollection
    match /trucks/{truckId}/menus/{menuId} {
      allow read: if true;  // Public read
      allow write: if isTruckOwner(truckId) || isAdmin();
    }

    // ═══════════════════════════════════════════════════════════
    // STAMP CARDS (Customer loyalty)
    // ═══════════════════════════════════════════════════════════
    match /stampCards/{cardId} {
      // Read: User can read their own stamp cards
      allow read: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Create: Authenticated users (when first visit)
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // Update: System only (via check-in), or truck owner (issuing coupon)
      allow update: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isTruckOwner(resource.data.truckId));

      allow delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // USER COUPONS (Earned coupons)
    // ═══════════════════════════════════════════════════════════
    match /userCoupons/{couponId} {
      // Read: User can read their own coupons
      allow read: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Create: System only (via stamp completion)
      allow create: if isAuthenticated();

      // Update: Truck owner can mark as used
      allow update: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isTruckOwner(resource.data.truckId));

      allow delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // REVIEWS
    // ═══════════════════════════════════════════════════════════
    match /reviews/{reviewId} {
      allow read: if true;  // Public read

      // Create: Authenticated users only, must be the author
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // Update: Only the author
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Delete: Author or admin
      allow delete: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ═══════════════════════════════════════════════════════════
    // ORDERS
    // ═══════════════════════════════════════════════════════════
    match /orders/{orderId} {
      // Read: User can see their own orders, Owner can see orders for their truck
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isTruckOwner(resource.data.truckId));

      // Create: Authenticated users, must be the orderer
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // Update: Only truck owner (for status changes)
      allow update: if isTruckOwner(resource.data.truckId);

      // Delete: Not allowed
      allow delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // FAVORITES
    // ═══════════════════════════════════════════════════════════
    match /favorites/{favoriteId} {
      allow read: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      allow update: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // FOLLOWS (Social Features)
    // ═══════════════════════════════════════════════════════════
    match /follows/{followId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // User's following subcollection (for quick lookup)
    match /users/{userId}/following/{truckId} {
      allow read, write: if isAuthenticated()
        && request.auth.uid == userId;
    }

    // Truck's followers subcollection
    match /trucks/{truckId}/followers/{userId} {
      allow read: if true;  // Public read for follower count
      allow write: if isAuthenticated()
        && request.auth.uid == userId;
    }

    // ═══════════════════════════════════════════════════════════
    // COUPONS (Owner-defined)
    // ═══════════════════════════════════════════════════════════
    match /coupons/{couponId} {
      // Read: Any authenticated user (customers need to see valid coupons)
      allow read: if isAuthenticated();

      // Create, Update, Delete: Only truck owner
      allow create, update, delete: if isAuthenticated()
        && isTruckOwner(request.resource.data.truckId);
    }

    // ═══════════════════════════════════════════════════════════
    // CHAT (Real-time messaging)
    // ═══════════════════════════════════════════════════════════
    match /chatRooms/{roomId} {
      // Read: User or truck owner can read
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isTruckOwner(resource.data.truckId));

      // Create: Authenticated user, must be participant
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // Update: Participants only (for unreadCount, lastMessage)
      allow update: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isTruckOwner(resource.data.truckId));

      // Messages subcollection
      match /messages/{messageId} {
        // Read: Participants only
        allow read: if isAuthenticated()
          && (get(/databases/$(database)/documents/chatRooms/$(roomId)).data.userId == request.auth.uid
              || isTruckOwner(get(/databases/$(database)/documents/chatRooms/$(roomId)).data.truckId));

        // Create: Authenticated users, must be sender
        allow create: if isAuthenticated()
          && request.resource.data.senderId == request.auth.uid;

        // Update: For isRead flag only
        allow update: if isAuthenticated();

        // Delete: Not allowed
        allow delete: if false;
      }
    }

    // ═══════════════════════════════════════════════════════════
    // SCHEDULES
    // ═══════════════════════════════════════════════════════════
    match /schedules/{scheduleId} {
      allow read: if true;  // Public read

      // Write: Truck owner only
      allow create, update, delete: if isAuthenticated()
        && isTruckOwner(resource.data.truckId);
    }

    // ═══════════════════════════════════════════════════════════
    // ANALYTICS
    // ═══════════════════════════════════════════════════════════
    match /analytics/{analyticsId} {
      // Read: Truck owner or admin
      allow read: if isAuthenticated()
        && (isTruckOwner(resource.data.truckId) || isAdmin());

      // Create/Update: System or truck owner
      allow create, update: if isAuthenticated();

      allow delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // CHECK-INS
    // ═══════════════════════════════════════════════════════════
    match /checkins/{checkinId} {
      // Read: User can see their own check-ins, owner can see their truck's
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isTruckOwner(resource.data.truckId));

      // Create: Authenticated user, must be the checker
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow update, delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // NOTIFICATION SETTINGS
    // ═══════════════════════════════════════════════════════════
    match /notificationSettings/{userId} {
      // Read: User can only read their own settings
      allow read: if isAuthenticated()
        && request.auth.uid == userId;

      // Create, Update: User can only modify their own settings
      allow create, update: if isAuthenticated()
        && request.auth.uid == userId;

      // Delete: Not allowed (use resetToDefault instead)
      allow delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // USERS (Profile data)
    // ═══════════════════════════════════════════════════════════
    match /users/{userId} {
      // Read: Authenticated users (for public profiles like owner info)
      allow read: if isAuthenticated();

      // Create/Update: Only the user themselves
      allow create, update: if isAuthenticated()
        && request.auth.uid == userId
        // Prevent users from changing their own role
        && (!('role' in request.resource.data)
            || request.resource.data.role == resource.data.role);

      allow delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // NOTIFICATIONS
    // ═══════════════════════════════════════════════════════════
    match /notifications/{notificationId} {
      // Read: User can only read their own notifications
      allow read: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Create: System/admin only (via Cloud Functions or admin SDK)
      allow create: if isAuthenticated() && isAdmin();

      // Update: User can mark as read
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Delete: User can delete their own notifications
      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ═══════════════════════════════════════════════════════════
    // OWNER REQUESTS (Owner verification system)
    // ═══════════════════════════════════════════════════════════
    match /owner_requests/{requestId} {
      // Read: User can read their own request, admins can read all
      allow read: if isAuthenticated()
        && (request.auth.uid == requestId || isAdmin());

      // Create: User can submit their own request
      allow create: if isAuthenticated()
        && request.auth.uid == requestId;

      // Update: Only admins can approve/reject
      allow update: if isAuthenticated() && isAdmin();

      // Delete: Not allowed
      allow delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // POSTS (Social Feed)
    // ═══════════════════════════════════════════════════════════
    match /posts/{postId} {
      allow read: if true;  // Public read

      // Create: Truck owner only
      allow create: if isAuthenticated()
        && isTruckOwner(request.resource.data.truckId);

      // Update/Delete: Post author or admin
      allow update, delete: if isAuthenticated()
        && (resource.data.authorId == request.auth.uid || isAdmin());
    }

    // ═══════════════════════════════════════════════════════════
    // COMMENTS
    // ═══════════════════════════════════════════════════════════
    match /comments/{commentId} {
      allow read: if true;  // Public read

      // Create: Authenticated user
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // Update/Delete: Comment author or admin
      allow update, delete: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ═══════════════════════════════════════════════════════════
    // BUSINESS APPROVALS (New - for owner business approval)
    // ═══════════════════════════════════════════════════════════
    match /business_approvals/{truckId} {
      // Read: Truck owner or admin
      allow read: if isAuthenticated()
        && (isTruckOwner(truckId) || isAdmin());

      // Create: Truck owner only
      allow create: if isAuthenticated()
        && isTruckOwner(truckId);

      // Update: Admin only (for approval/rejection)
      allow update: if isAuthenticated() && isAdmin();

      allow delete: if false;
    }
  }
}
