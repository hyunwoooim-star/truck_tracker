rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function: Check if user owns the truck
    function isTruckOwner(truckId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/trucks/$(truckId)).data.ownerId == request.auth.uid;
    }

    // ═══════════════════════════════════════════════════════════
    // TRUCKS
    // ═══════════════════════════════════════════════════════════
    match /trucks/{truckId} {
      allow read: if true;  // Public read
      allow create: if isAuthenticated();
      allow update, delete: if isTruckOwner(truckId);
    }

    // ═══════════════════════════════════════════════════════════
    // REVIEWS
    // ═══════════════════════════════════════════════════════════
    match /reviews/{reviewId} {
      allow read: if true;  // Public read
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ═══════════════════════════════════════════════════════════
    // ORDERS
    // ═══════════════════════════════════════════════════════════
    match /orders/{orderId} {
      // Read: User can see their own orders, Owner can see orders for their truck
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isTruckOwner(resource.data.truckId));

      // Create: Any authenticated user
      allow create: if isAuthenticated();

      // Update: Only truck owner (for status changes)
      allow update: if isTruckOwner(resource.data.truckId);

      // Delete: Not allowed
      allow delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // FAVORITES
    // ═══════════════════════════════════════════════════════════
    match /favorites/{favoriteId} {
      allow read: if isAuthenticated();
      allow create, delete: if isAuthenticated();
      allow update: if false;  // Not needed
    }

    // ═══════════════════════════════════════════════════════════
    // PHASE 11: FOLLOWS (Social Features)
    // ═══════════════════════════════════════════════════════════
    match /follows/{followId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // User's following subcollection (for quick lookup)
    match /users/{userId}/following/{truckId} {
      allow read, write: if isAuthenticated()
        && request.auth.uid == userId;
    }

    // Truck's followers subcollection
    match /trucks/{truckId}/followers/{userId} {
      allow read: if true;  // Public read for follower count
      allow write: if isAuthenticated()
        && request.auth.uid == userId;
    }

    // ═══════════════════════════════════════════════════════════
    // PHASE 12: COUPONS
    // ═══════════════════════════════════════════════════════════
    match /coupons/{couponId} {
      // Read: Any authenticated user (customers need to see valid coupons)
      allow read: if isAuthenticated();

      // Create, Update, Delete: Only truck owner
      allow create, update, delete: if isAuthenticated()
        && isTruckOwner(request.resource.data.truckId);
    }

    // ═══════════════════════════════════════════════════════════
    // PHASE 13: CHAT (Real-time messaging)
    // ═══════════════════════════════════════════════════════════
    match /chatRooms/{roomId} {
      // Read: User or truck owner can read
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isTruckOwner(resource.data.truckId));

      // Create: Any authenticated user
      allow create: if isAuthenticated();

      // Update: Participants only (for unreadCount, lastMessage)
      allow update: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isTruckOwner(resource.data.truckId));

      // Messages subcollection
      match /messages/{messageId} {
        // Read: Participants only
        allow read: if isAuthenticated()
          && (get(/databases/$(database)/documents/chatRooms/$(roomId)).data.userId == request.auth.uid
              || isTruckOwner(get(/databases/$(database)/documents/chatRooms/$(roomId)).data.truckId));

        // Create: Authenticated users, must be sender
        allow create: if isAuthenticated()
          && request.resource.data.senderId == request.auth.uid;

        // Update: For isRead flag only
        allow update: if isAuthenticated();

        // Delete: Not allowed
        allow delete: if false;
      }
    }

    // ═══════════════════════════════════════════════════════════
    // SCHEDULES
    // ═══════════════════════════════════════════════════════════
    match /schedules/{scheduleId} {
      allow read: if true;  // Public read
      allow create, update, delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════
    // ANALYTICS
    // ═══════════════════════════════════════════════════════════
    match /analytics/{analyticsId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // CHECK-INS
    // ═══════════════════════════════════════════════════════════
    match /checkins/{checkinId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // PHASE 15: NOTIFICATION SETTINGS
    // ═══════════════════════════════════════════════════════════
    match /notificationSettings/{userId} {
      // Read: User can only read their own settings
      allow read: if isAuthenticated()
        && request.auth.uid == userId;

      // Create, Update: User can only modify their own settings
      allow create, update: if isAuthenticated()
        && request.auth.uid == userId;

      // Delete: Not allowed (use resetToDefault instead)
      allow delete: if false;
    }

    // ═══════════════════════════════════════════════════════════
    // USERS (Profile data)
    // ═══════════════════════════════════════════════════════════
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated()
        && request.auth.uid == userId;
      allow delete: if false;
    }
  }
}
